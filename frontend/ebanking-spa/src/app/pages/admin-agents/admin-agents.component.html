<div class="admin-agents-page">
  <app-page-header
    title="Agent Management"
    subtitle="Manage agents, assign clients, and view performance"
    [breadcrumbs]="['Home', 'Admin', 'Agent Management']">
  </app-page-header>

  @if (loading && agents.length === 0) {
    <app-loader [fullScreen]="false" message="Loading agents..."></app-loader>
  } @else {
    <div class="content-card">
      <!-- Actions Bar -->
      <div class="actions-bar">
        <div class="search-section">
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Search agents</mat-label>
            <input matInput [(ngModel)]="searchQuery" (keyup.enter)="onFilterAgents()" placeholder="Name, email...">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
          <button mat-stroked-button (click)="onFilterAgents()">
            <mat-icon>search</mat-icon>
            Search
          </button>
        </div>
        
        <button mat-flat-button color="primary" (click)="onCreateAgent()">
          <mat-icon>person_add</mat-icon>
          Create Agent
        </button>
      </div>

      @if (errorMessage) {
        <div class="error-message">{{ errorMessage }}</div>
      }

      <!-- Agents Table -->
      @if (agents.length > 0) {
        <div class="table-container">
          <table mat-table [dataSource]="agents" class="agents-table">
            
            <!-- Name Column -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Agent</th>
              <td mat-cell *matCellDef="let agent">
                <div class="agent-name">
                  <strong>{{ agent.fullName }}</strong>
                  <span class="agent-email">{{ agent.email }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Email Column -->
            <ng-container matColumnDef="email">
              <th mat-header-cell *matHeaderCellDef>Contact</th>
              <td mat-cell *matCellDef="let agent">
                <div>{{ agent.phoneNumber || 'N/A' }}</div>
                <div class="agent-status">
                  <mat-chip [color]="agent.status === 'ACTIVE' ? 'primary' : 'warn'">
                    {{ agent.status }}
                  </mat-chip>
                </div>
              </td>
            </ng-container>

            <!-- Clients Column -->
            <ng-container matColumnDef="clients">
              <th mat-header-cell *matHeaderCellDef>Clients</th>
              <td mat-cell *matCellDef="let agent">
                @if (getPerformance(agent.id)) {
                  <div class="performance-stats">
                    <div class="stat-item">
                      <mat-icon>people</mat-icon>
                      <span><strong>{{ getPerformance(agent.id)!.totalClients }}</strong> Total</span>
                    </div>
                    <div class="stat-item">
                      <mat-icon>check_circle</mat-icon>
                      <span><strong>{{ getPerformance(agent.id)!.activeClients }}</strong> Active</span>
                    </div>
                    <div class="stat-item">
                      <mat-icon>trending_up</mat-icon>
                      <span><strong>{{ getPerformance(agent.id)!.newClientsThisMonth }}</strong> New (Month)</span>
                    </div>
                  </div>
                } @else {
                  <div>Loading...</div>
                }
              </td>
            </ng-container>

            <!-- Performance Column -->
            <ng-container matColumnDef="performance">
              <th mat-header-cell *matHeaderCellDef>KYC Status</th>
              <td mat-cell *matCellDef="let agent">
                @if (getPerformance(agent.id)) {
                  <div class="kyc-stats">
                    <mat-chip color="primary">{{ getPerformance(agent.id)!.verifiedKyc }} Verified</mat-chip>
                    <mat-chip color="accent">{{ getPerformance(agent.id)!.pendingKyc }} Pending</mat-chip>
                  </div>
                } @else {
                  <div>Loading...</div>
                }
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let agent">
                <div class="action-buttons">
                  <button mat-icon-button [matMenuTriggerFor]="menu" color="primary" matTooltip="Actions">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="onViewAgentDetails(agent)">
                      <mat-icon>visibility</mat-icon>
                      <span>View Details</span>
                    </button>
                    <button mat-menu-item (click)="onAssignClients(agent)">
                      <mat-icon>person_add</mat-icon>
                      <span>Assign Clients</span>
                    </button>
                    <button mat-menu-item (click)="onDeleteAgent(agent)" class="delete-action">
                      <mat-icon>block</mat-icon>
                      <span>Deactivate Agent</span>
                    </button>
                  </mat-menu>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>
      } @else if (!loading) {
        <div class="empty-state">
          <mat-icon>supervisor_account</mat-icon>
          <p>No agents found</p>
          <p class="empty-subtitle">Start by creating a new agent</p>
        </div>
      }
    </div>
  }
</div>

