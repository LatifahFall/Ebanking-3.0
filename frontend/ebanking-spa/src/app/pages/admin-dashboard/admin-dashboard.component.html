<div class="admin-dashboard-page">
  <app-page-header
    title="Admin Dashboard"
    subtitle="System overview, user management, and monitoring"
    [breadcrumbs]="['Home', 'Admin Dashboard']">
  </app-page-header>

  @if (loading) {
    <app-loader [fullScreen]="false" message="Loading dashboard data..."></app-loader>
  } @else {
    <mat-tab-group [(selectedIndex)]="selectedTab" class="dashboard-tabs">
      <!-- System Overview Tab -->
      <mat-tab label="System Overview">
        <div class="tab-content">
          <!-- Statistics Cards -->
          <div class="stats-grid">
            <mat-card class="stat-card">
              <mat-card-content>
                <div class="stat-header">
                  <mat-icon>people</mat-icon>
                  <h3>Total Users</h3>
                </div>
                <div class="stat-value">{{ systemStats?.totalUsers || 0 }}</div>
                <div class="stat-details">
                  <span class="stat-label">Active: {{ systemStats?.activeUsers || 0 }}</span>
                  <span class="stat-label">New this month: {{ systemStats?.newUsersThisMonth || 0 }}</span>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card class="stat-card">
              <mat-card-content>
                <div class="stat-header">
                  <mat-icon>account_balance</mat-icon>
                  <h3>Total Revenue</h3>
                </div>
                <div class="stat-value">{{ systemStats?.totalRevenue | currency:'USD':'symbol':'1.0-0' }}</div>
                <div class="stat-details">
                  <span class="stat-label">Transactions: {{ systemStats?.totalTransactions || 0 }}</span>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card class="stat-card">
              <mat-card-content>
                <div class="stat-header">
                  <mat-icon>account_balance_wallet</mat-icon>
                  <h3>Total Accounts</h3>
                </div>
                <div class="stat-value">{{ systemStats?.totalAccounts || 0 }}</div>
                <div class="stat-details">
                  <span class="stat-label">Active users: {{ systemStats?.activeUsers || 0 }}</span>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card class="stat-card">
              <mat-card-content>
                <div class="stat-header">
                  <mat-icon>verified_user</mat-icon>
                  <h3>KYC Status</h3>
                </div>
                <div class="stat-value">{{ systemStats?.verifiedKyc || 0 }} / {{ systemStats?.totalClients || 0 }}</div>
                <div class="stat-details">
                  <span class="stat-label">Pending: {{ systemStats?.pendingKyc || 0 }}</span>
                  <span class="stat-label">Rejected: {{ systemStats?.rejectedKyc || 0 }}</span>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card class="stat-card">
              <mat-card-content>
                <div class="stat-header">
                  <mat-icon>supervisor_account</mat-icon>
                  <h3>By Role</h3>
                </div>
                <div class="stat-value">{{ systemStats?.totalClients || 0 }} Clients</div>
                <div class="stat-details">
                  <span class="stat-label">{{ systemStats?.totalAgents || 0 }} Agents</span>
                  <span class="stat-label">{{ systemStats?.totalAdmins || 0 }} Admins</span>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card class="stat-card">
              <mat-card-content>
                <div class="stat-header">
                  <mat-icon>warning</mat-icon>
                  <h3>System Alerts</h3>
                </div>
                <div class="stat-value">{{ activeAlertsCount }}</div>
                <div class="stat-details">
                  <span class="stat-label">Active alerts</span>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Charts -->
          <div class="charts-grid">
            <mat-card class="chart-card">
              <mat-card-header>
                <mat-card-title>User Growth (Last 6 Months)</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                @if (userGrowthChart) {
                  <app-chart-widget [data]="userGrowthChart" type="line"></app-chart-widget>
                } @else {
                  <div class="chart-placeholder">Loading chart data...</div>
                }
              </mat-card-content>
            </mat-card>

            <mat-card class="chart-card">
              <mat-card-header>
                <mat-card-title>Revenue Trend (Last 6 Months)</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                @if (revenueChart) {
                  <app-chart-widget [data]="revenueChart" type="line"></app-chart-widget>
                } @else {
                  <div class="chart-placeholder">Loading chart data...</div>
                }
              </mat-card-content>
            </mat-card>

            <mat-card class="chart-card">
              <mat-card-header>
                <mat-card-title>User Distribution by Role</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                @if (userDistributionChart) {
                  <app-chart-widget [data]="userDistributionChart" type="bar"></app-chart-widget>
                } @else {
                  <div class="chart-placeholder">Loading chart data...</div>
                }
              </mat-card-content>
            </mat-card>
          </div>

          <!-- System Alerts -->
          <mat-card class="alerts-card">
            <mat-card-header>
              <mat-card-title>System Alerts</mat-card-title>
              <button mat-icon-button (click)="loadDashboardData()" matTooltip="Refresh">
                <mat-icon>refresh</mat-icon>
              </button>
            </mat-card-header>
            <mat-card-content>
              @if (activeAlerts.length > 0) {
                <table mat-table [dataSource]="activeAlerts" class="alerts-table">
                  <ng-container matColumnDef="type">
                    <th mat-header-cell *matHeaderCellDef>Type</th>
                    <td mat-cell *matCellDef="let alert">
                      <mat-icon [color]="getAlertTypeColor(alert.type)">{{ getAlertTypeIcon(alert.type) }}</mat-icon>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="title">
                    <th mat-header-cell *matHeaderCellDef>Title</th>
                    <td mat-cell *matCellDef="let alert">
                      <strong>{{ alert.title }}</strong>
                      <div class="alert-message">{{ alert.message }}</div>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="severity">
                    <th mat-header-cell *matHeaderCellDef>Severity</th>
                    <td mat-cell *matCellDef="let alert">
                      <mat-chip-row [color]="getSeverityColor(alert.severity)" selected>
                        {{ alert.severity.toUpperCase() }}
                      </mat-chip-row>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="timestamp">
                    <th mat-header-cell *matHeaderCellDef>Time</th>
                    <td mat-cell *matCellDef="let alert">{{ alert.timestamp | date:'short' }}</td>
                  </ng-container>

                  <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>Actions</th>
                    <td mat-cell *matCellDef="let alert">
                      <button mat-icon-button (click)="onResolveAlert(alert.id)" matTooltip="Mark as resolved">
                        <mat-icon>check_circle</mat-icon>
                      </button>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="alertsColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: alertsColumns;"></tr>
                </table>
              } @else {
                <div class="empty-state">
                  <mat-icon>check_circle</mat-icon>
                  <p>No active alerts</p>
                </div>
              }
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- User Management Tab -->
      <mat-tab label="User Management">
        <div class="tab-content">
          <div class="user-management-header">
            <h2>User Overview</h2>
            <button mat-flat-button color="primary" (click)="onCreateUser()">
              <mat-icon>add</mat-icon> Create User
            </button>
          </div>

          <div class="user-stats-grid">
            <mat-card>
              <mat-card-content>
                <div class="user-stat">
                  <mat-icon>people</mat-icon>
                  <div>
                    <div class="user-stat-value">{{ systemStats?.totalUsers || 0 }}</div>
                    <div class="user-stat-label">Total Users</div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card>
              <mat-card-content>
                <div class="user-stat">
                  <mat-icon>person</mat-icon>
                  <div>
                    <div class="user-stat-value">{{ systemStats?.totalClients || 0 }}</div>
                    <div class="user-stat-label">Clients</div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card>
              <mat-card-content>
                <div class="user-stat">
                  <mat-icon>supervisor_account</mat-icon>
                  <div>
                    <div class="user-stat-value">{{ systemStats?.totalAgents || 0 }}</div>
                    <div class="user-stat-label">Agents</div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card>
              <mat-card-content>
                <div class="user-stat">
                  <mat-icon>admin_panel_settings</mat-icon>
                  <div>
                    <div class="user-stat-value">{{ systemStats?.totalAdmins || 0 }}</div>
                    <div class="user-stat-label">Admins</div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card>
              <mat-card-content>
                <div class="user-stat">
                  <mat-icon>check_circle</mat-icon>
                  <div>
                    <div class="user-stat-value">{{ systemStats?.activeUsers || 0 }}</div>
                    <div class="user-stat-label">Active</div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card>
              <mat-card-content>
                <div class="user-stat">
                  <mat-icon>trending_up</mat-icon>
                  <div>
                    <div class="user-stat-value">{{ systemStats?.newUsersThisMonth || 0 }}</div>
                    <div class="user-stat-label">New This Month</div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <mat-card class="quick-actions-card">
            <mat-card-header>
              <mat-card-title>Quick Actions</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="quick-actions">
                <button mat-stroked-button routerLink="/admin/users">
                  <mat-icon>manage_accounts</mat-icon>
                  Manage All Users
                </button>
                <button mat-stroked-button (click)="onCreateUser()">
                  <mat-icon>person_add</mat-icon>
                  Create New User
                </button>
                <button mat-stroked-button routerLink="/admin/users">
                  <mat-icon>assignment</mat-icon>
                  Assign Agent to Client
                </button>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- System Monitoring Tab -->
      <mat-tab label="System Monitoring">
        <div class="tab-content">
          <!-- Service Health -->
          <mat-card class="monitoring-card">
            <mat-card-header>
              <mat-card-title>Service Health</mat-card-title>
              <button mat-icon-button (click)="loadDashboardData()" matTooltip="Refresh">
                <mat-icon>refresh</mat-icon>
              </button>
            </mat-card-header>
            <mat-card-content>
              <table mat-table [dataSource]="serviceHealth" class="health-table">
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Service</th>
                  <td mat-cell *matCellDef="let service">{{ service.name }}</td>
                </ng-container>

                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>Status</th>
                  <td mat-cell *matCellDef="let service">
                    <mat-chip-row [color]="getServiceStatusColor(service.status)" selected>
                      {{ service.status }}
                    </mat-chip-row>
                  </td>
                </ng-container>

                <ng-container matColumnDef="responseTime">
                  <th mat-header-cell *matHeaderCellDef>Response Time (ms)</th>
                  <td mat-cell *matCellDef="let service">
                    {{ service.responseTime || 'N/A' }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="lastCheck">
                  <th mat-header-cell *matHeaderCellDef>Last Check</th>
                  <td mat-cell *matCellDef="let service">{{ service.lastCheck | date:'short' }}</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="healthColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: healthColumns;"></tr>
              </table>
            </mat-card-content>
          </mat-card>

          <!-- API Performance -->
          <mat-card class="monitoring-card">
            <mat-card-header>
              <mat-card-title>API Performance</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <table mat-table [dataSource]="apiPerformance" class="performance-table">
                <ng-container matColumnDef="endpoint">
                  <th mat-header-cell *matHeaderCellDef>Endpoint</th>
                  <td mat-cell *matCellDef="let perf">{{ perf.endpoint }}</td>
                </ng-container>

                <ng-container matColumnDef="method">
                  <th mat-header-cell *matHeaderCellDef>Method</th>
                  <td mat-cell *matCellDef="let perf">
                    <mat-chip-row [color]="perf.method === 'GET' ? 'primary' : 'accent'" selected>
                      {{ perf.method }}
                    </mat-chip-row>
                  </td>
                </ng-container>

                <ng-container matColumnDef="avgResponseTime">
                  <th mat-header-cell *matHeaderCellDef>Avg Response (ms)</th>
                  <td mat-cell *matCellDef="let perf">{{ perf.avgResponseTime }}</td>
                </ng-container>

                <ng-container matColumnDef="requestCount">
                  <th mat-header-cell *matHeaderCellDef>Total Requests</th>
                  <td mat-cell *matCellDef="let perf">{{ perf.requestCount | number }}</td>
                </ng-container>

                <ng-container matColumnDef="errorRate">
                  <th mat-header-cell *matHeaderCellDef>Error Rate</th>
                  <td mat-cell *matCellDef="let perf">
                    <span [class.error-high]="perf.errorRate > 1">{{ perf.errorRate }}%</span>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="performanceColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: performanceColumns;"></tr>
              </table>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>
    </mat-tab-group>
  }
</div>

