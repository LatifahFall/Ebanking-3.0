<div class="agent-support-page">
  <app-page-header
    title="Client Support"
    subtitle="Manage client tickets and requests"
    [breadcrumbs]="['Home', 'Support']">
  </app-page-header>

  @if (loading && tickets.length === 0) {
    <app-loader [fullScreen]="false" message="Loading tickets..."></app-loader>
  } @else {
    <div class="support-content">
      <!-- Tickets List -->
      <mat-card class="tickets-card">
        <mat-card-header>
          <mat-card-title>Tickets</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <!-- Filters -->
          <div class="filters-section">
            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Status</mat-label>
              <mat-select [(ngModel)]="statusFilter" (selectionChange)="onFilterChange()">
                <mat-option value="ALL">All Statuses</mat-option>
                <mat-option value="OPEN">Open</mat-option>
                <mat-option value="IN_PROGRESS">In Progress</mat-option>
                <mat-option value="RESOLVED">Resolved</mat-option>
                <mat-option value="CLOSED">Closed</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Priority</mat-label>
              <mat-select [(ngModel)]="priorityFilter" (selectionChange)="onFilterChange()">
                <mat-option value="ALL">All Priorities</mat-option>
                <mat-option value="URGENT">Urgent</mat-option>
                <mat-option value="HIGH">High</mat-option>
                <mat-option value="MEDIUM">Medium</mat-option>
                <mat-option value="LOW">Low</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Tickets Table -->
          @if (filteredTickets.length > 0) {
            <table mat-table [dataSource]="filteredTickets" class="tickets-table">
              <ng-container matColumnDef="client">
                <th mat-header-cell *matHeaderCellDef>Client</th>
                <td mat-cell *matCellDef="let ticket">{{ ticket.clientName }}</td>
              </ng-container>

              <ng-container matColumnDef="subject">
                <th mat-header-cell *matHeaderCellDef>Subject</th>
                <td mat-cell *matCellDef="let ticket">{{ ticket.subject }}</td>
              </ng-container>

              <ng-container matColumnDef="category">
                <th mat-header-cell *matHeaderCellDef>Category</th>
                <td mat-cell *matCellDef="let ticket">{{ ticket.category }}</td>
              </ng-container>

              <ng-container matColumnDef="priority">
                <th mat-header-cell *matHeaderCellDef>Priority</th>
                <td mat-cell *matCellDef="let ticket">
                  <mat-chip [color]="getPriorityColor(ticket.priority)">
                    {{ ticket.priority }}
                  </mat-chip>
                </td>
              </ng-container>

              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let ticket">
                  <mat-chip [color]="getStatusColor(ticket.status)">
                    {{ ticket.status }}
                  </mat-chip>
                </td>
              </ng-container>

              <ng-container matColumnDef="createdAt">
                <th mat-header-cell *matHeaderCellDef>Created</th>
                <td mat-cell *matCellDef="let ticket">{{ ticket.createdAt | date:'short' }}</td>
              </ng-container>

              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let ticket">
                  <button mat-button color="primary" (click)="onViewTicket(ticket)">
                    <mat-icon>visibility</mat-icon>
                    View
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
          } @else {
            <div class="empty-state">
              <mat-icon>support_agent</mat-icon>
              <p>No tickets found</p>
            </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Ticket Details -->
      @if (selectedTicket) {
        <mat-card class="ticket-details-card">
          <mat-card-header>
            <div class="ticket-header">
              <div>
                <h2>{{ selectedTicket.subject }}</h2>
                <p class="ticket-meta">From: {{ selectedTicket.clientName }} | Created: {{ selectedTicket.createdAt | date:'medium' }}</p>
              </div>
              <div class="ticket-badges">
                <mat-chip [color]="getPriorityColor(selectedTicket.priority)">
                  {{ selectedTicket.priority }}
                </mat-chip>
                <mat-chip [color]="getStatusColor(selectedTicket.status)">
                  {{ selectedTicket.status }}
                </mat-chip>
              </div>
            </div>
          </mat-card-header>
          <mat-card-content>
            <mat-tab-group>
              <mat-tab label="Description">
                <div class="tab-content">
                  <p>{{ selectedTicket.description }}</p>
                </div>
              </mat-tab>

              <mat-tab label="Notes">
                <div class="tab-content">
                  <div class="notes-section">
                    @for (note of selectedTicket.notes; track note.id) {
                      <div class="note-item">
                        <div class="note-header">
                          <strong>{{ note.authorName }}</strong>
                          <span class="note-date">{{ note.createdAt | date:'short' }}</span>
                        </div>
                        <p class="note-content">{{ note.content }}</p>
                      </div>
                    }
                    @if (selectedTicket.notes.length === 0) {
                      <p class="no-notes">No notes yet</p>
                    }
                  </div>

                  <div class="add-note-section">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Add Note</mat-label>
                      <textarea matInput [(ngModel)]="newNote" rows="3" placeholder="Add a note..."></textarea>
                    </mat-form-field>
                    <button mat-raised-button color="primary" (click)="onAddNote()">
                      <mat-icon>add</mat-icon>
                      Add Note
                    </button>
                  </div>
                </div>
              </mat-tab>

              <mat-tab label="Actions">
                <div class="tab-content">
                  <div class="actions-section">
                    <h3>Update Status</h3>
                    <div class="status-buttons">
                      <button mat-button (click)="onUpdateStatus(selectedTicket, TicketStatus.OPEN)">Open</button>
                      <button mat-button (click)="onUpdateStatus(selectedTicket, TicketStatus.IN_PROGRESS)">In Progress</button>
                      <button mat-button (click)="onUpdateStatus(selectedTicket, TicketStatus.RESOLVED)">Resolved</button>
                      <button mat-button (click)="onUpdateStatus(selectedTicket, TicketStatus.CLOSED)">Close</button>
                    </div>
                  </div>
                </div>
              </mat-tab>
            </mat-tab-group>
          </mat-card-content>
        </mat-card>
      }
    </div>
  }
</div>

