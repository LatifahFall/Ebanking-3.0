<div class="analytics-page">
  <app-page-header
    title="Analytics"
    subtitle="Financial insights and trends"
    [breadcrumbs]="['Home', 'Analytics']">
  </app-page-header>

  <!-- Client Selection for Agents and Admins -->
  @if (isAgentOrAdmin) {
    <mat-card class="client-selector-card">
      <mat-card-content>
        <mat-form-field appearance="outline" class="client-select-field">
          <mat-label>Select Client</mat-label>
          <input
            type="text"
            matInput
            [formControl]="clientSearchControl"
            [matAutocomplete]="clientAuto"
            placeholder="Search for a client...">
          <mat-autocomplete
            #clientAuto="matAutocomplete"
            [displayWith]="displayClient"
            (optionSelected)="onClientSelected($event.option.value)">
            @for (client of filteredClients$ | async; track client.id) {
              <mat-option [value]="client">
                <strong>{{ client.firstName }} {{ client.lastName }}</strong>
                <span class="client-email"> - {{ client.email }}</span>
              </mat-option>
            }
          </mat-autocomplete>
          <mat-icon matPrefix>person_search</mat-icon>
        </mat-form-field>
        @if (selectedClient) {
          <div class="selected-client-info">
            <mat-icon>person</mat-icon>
            <span>Viewing analytics for: <strong>{{ selectedClient.firstName }} {{ selectedClient.lastName }}</strong></span>
          </div>
        }
      </mat-card-content>
    </mat-card>
  }

  @if (loading) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Loading analytics...</p>
    </div>
  } @else {
    <div class="analytics-content">
      <!-- Summary Cards from DashboardSummary -->
      <div class="summary-cards">
        <mat-card class="stat-card">
          <div class="stat-icon" style="background: #EBF5FF;">
            <mat-icon style="color: #1E6AE1;">account_balance_wallet</mat-icon>
          </div>
          <div class="stat-content">
            <h3>Current Balance</h3>
            <p class="stat-value">{{ dashboardSummary ? formatCurrency(dashboardSummary.currentBalance) : '$0.00' }}</p>
            <span class="stat-label">As of {{ getGeneratedAtFormatted() }}</span>
          </div>
        </mat-card>

        <mat-card class="stat-card">
          <div class="stat-icon" style="background: #D1FAE5;">
            <mat-icon style="color: #10B981;">trending_up</mat-icon>
          </div>
          <div class="stat-content">
            <h3>Monthly Income</h3>
            <p class="stat-value income">{{ dashboardSummary ? formatCurrency(dashboardSummary.monthlyIncome) : '$0.00' }}</p>
            <span class="stat-label">This month</span>
          </div>
        </mat-card>

        <mat-card class="stat-card">
          <div class="stat-icon" style="background: #FEE2E2;">
            <mat-icon style="color: #EF4444;">trending_down</mat-icon>
          </div>
          <div class="stat-content">
            <h3>Monthly Spending</h3>
            <p class="stat-value expense">{{ dashboardSummary ? formatCurrency(dashboardSummary.monthlySpending) : '$0.00' }}</p>
            <span class="stat-label">This month</span>
          </div>
        </mat-card>

        <mat-card class="stat-card">
          <div class="stat-icon" style="background: #FEF3C7;">
            <mat-icon style="color: #F59E0B;">receipt</mat-icon>
          </div>
          <div class="stat-content">
            <h3>Transactions</h3>
            <p class="stat-value">{{ dashboardSummary?.transactionsThisMonth || 0 }}</p>
            <span class="stat-label">This month</span>
          </div>
        </mat-card>
      </div>

      <!-- Balance Trend Chart -->
      <div class="charts-section">
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>timeline</mat-icon>
              Balance Trend ({{ dashboardSummary?.balanceTrend?.period || '30 days' }})
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            @if (balanceTrendChart) {
              <app-chart-widget
                title="Balance Evolution"
                type="line"
                [height]="300"
                [data]="balanceTrendChart">
              </app-chart-widget>
            } @else {
              <div class="no-data">No data available</div>
            }
          </mat-card-content>
        </mat-card>

        <!-- Category Breakdown Chart -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>pie_chart</mat-icon>
              Spending by Category
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            @if (categoryChart) {
              <app-chart-widget
                title="Category Breakdown"
                type="bar"
                [height]="300"
                [data]="categoryChart">
              </app-chart-widget>
            } @else {
              <div class="no-data">No data available</div>
            }
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Category Breakdown List -->
      @if (categoryBreakdown.length > 0) {
        <mat-card class="category-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>category</mat-icon>
              Category Details
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="category-list">
              @for (category of categoryBreakdown; track category.category) {
                <div class="category-item">
                  <div class="category-info">
                    <div class="category-color" [style.background]="getCategoryColor(category.category)"></div>
                    <span class="category-name">{{ category.category }}</span>
                  </div>
                  <div class="category-stats">
                    <span class="category-amount">{{ formatCurrency(category.amount) }}</span>
                    <span class="category-percentage">{{ category.percentage.toFixed(1) }}%</span>
                    <span class="category-count">{{ category.count }} transactions</span>
                  </div>
                  <div class="category-bar">
                    <div class="category-bar-fill" 
                         [style.width.%]="category.percentage" 
                         [style.background]="getCategoryColor(category.category)"></div>
                  </div>
                </div>
              }
            </div>
          </mat-card-content>
        </mat-card>
      }

      <!-- Recommendations Section -->
      @if (recommendations.length > 0) {
        <mat-card class="recommendations-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>lightbulb</mat-icon>
              Recommendations
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <ul class="recommendations-list">
              @for (rec of recommendations; track rec) {
                <li>{{ rec }}</li>
              }
            </ul>
          </mat-card-content>
        </mat-card>
      }

      <!-- Active Alerts Section -->
      @if (activeAlerts.length > 0) {
        <mat-card class="alerts-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>notifications</mat-icon>
              Active Alerts ({{ activeAlerts.length }})
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="alerts-list">
              @for (alert of activeAlerts; track alert.alertId) {
                <div class="alert-item" [style.border-left-color]="getAlertSeverityColor(alert.severity)">
                  <div class="alert-header">
                    <div class="alert-info">
                      <mat-chip [style.background-color]="getAlertSeverityColor(alert.severity)" color="primary">
                        {{ formatAlertType(alert.alertType) }}
                      </mat-chip>
                      <span class="alert-severity">{{ alert.severity }}</span>
                    </div>
                    <button mat-icon-button (click)="onResolveAlert(alert.alertId)" matTooltip="Resolve alert">
                      <mat-icon>check_circle</mat-icon>
                    </button>
                  </div>
                  <h4 class="alert-title">{{ alert.title }}</h4>
                  <p class="alert-message">{{ alert.message }}</p>
                  <span class="alert-time">{{ alert.triggeredAt | date:'short' }}</span>
                </div>
              }
            </div>
          </mat-card-content>
        </mat-card>
      }
    </div>
  }
</div>

