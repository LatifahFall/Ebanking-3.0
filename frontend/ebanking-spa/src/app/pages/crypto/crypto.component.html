<div class="crypto-page">
  <app-page-header
    title="Crypto Wallet"
    subtitle="Manage your cryptocurrency portfolio"
    [breadcrumbs]="['Home', 'Crypto']">
  </app-page-header>

  @if (loading) {
    <app-loader [fullScreen]="false" message="Loading your crypto portfolio..."></app-loader>
  } @else if (errorMessage) {
    <div class="error-state">
      <mat-icon class="error-icon">error_outline</mat-icon>
      <h3>Unable to load crypto portfolio</h3>
      <p>{{ errorMessage }}</p>
      <app-custom-button
        label="Retry"
        icon="refresh"
        variant="primary"
        (clicked)="loadData()">
      </app-custom-button>
    </div>
  } @else if (portfolio) {
    <!-- Portfolio Overview -->
    <div class="portfolio-overview">
      <div class="portfolio-cards">
        <app-info-card
          title="Total Portfolio Value"
          [value]="formatCurrency(portfolio.totalValueEUR)"
          subtitle="All crypto assets"
          icon="account_balance_wallet"
          [trend]="portfolio.totalGainLossPercent"
          trendLabel="24h Change"
          color="#1E6AE1">
        </app-info-card>

        <app-info-card
          title="Total Gain/Loss"
          [value]="formatCurrency(portfolio.totalGainLoss)"
          [subtitle]="formatPercent(portfolio.totalGainLossPercent) + ' change'"
          icon="trending_up"
          [trend]="portfolio.totalGainLossPercent"
          trendLabel="Performance"
          [color]="portfolio.totalGainLoss >= 0 ? '#10B981' : '#EF4444'">
        </app-info-card>

        <app-info-card
          title="EUR Balance"
          [value]="formatCurrency(portfolio.wallet.balance)"
          subtitle="Available for trading"
          icon="euro"
          color="#F59E0B">
        </app-info-card>

        <app-info-card
          title="Active Holdings"
          [value]="portfolio.holdings.length"
          subtitle="Different cryptocurrencies"
          icon="category"
          color="#8B5CF6">
        </app-info-card>
      </div>
    </div>

    <!-- Main Content Tabs -->
    <mat-tab-group [(selectedIndex)]="selectedTab" class="crypto-tabs">
      <!-- Holdings Tab -->
      <mat-tab label="My Holdings">
        <div class="tab-content">
          @if (portfolio.holdings.length === 0) {
            <div class="empty-state">
              <mat-icon>wallet</mat-icon>
              <h3>No crypto holdings</h3>
              <p>Start by buying your first cryptocurrency</p>
            </div>
          } @else {
            <div class="holdings-section">
              <table mat-table [dataSource]="portfolio.holdings" class="holdings-table">
                <!-- Symbol Column -->
                <ng-container matColumnDef="symbol">
                  <th mat-header-cell *matHeaderCellDef>Cryptocurrency</th>
                  <td mat-cell *matCellDef="let holding">
                    <div class="crypto-info">
                      @if (holding.coinImage) {
                        <img [src]="holding.coinImage" [alt]="holding.cryptoSymbol" class="crypto-icon">
                      } @else {
                        <mat-icon class="crypto-icon-placeholder">monetization_on</mat-icon>
                      }
                      <div>
                        <div class="crypto-symbol">{{ holding.cryptoSymbol }}</div>
                        @if (holding.coinName) {
                          <div class="crypto-name">{{ holding.coinName }}</div>
                        }
                      </div>
                    </div>
                  </td>
                </ng-container>

                <!-- Amount Column -->
                <ng-container matColumnDef="amount">
                  <th mat-header-cell *matHeaderCellDef>Amount</th>
                  <td mat-cell *matCellDef="let holding">
                    {{ formatCrypto(holding.amount) }} {{ holding.cryptoSymbol }}
                  </td>
                </ng-container>

                <!-- Price Column -->
                <ng-container matColumnDef="price">
                  <th mat-header-cell *matHeaderCellDef>Current Price</th>
                  <td mat-cell *matCellDef="let holding">
                    {{ formatCurrency(holding.currentPrice) }}
                  </td>
                </ng-container>

                <!-- Value Column -->
                <ng-container matColumnDef="value">
                  <th mat-header-cell *matHeaderCellDef>Value (EUR)</th>
                  <td mat-cell *matCellDef="let holding">
                    <strong>{{ formatCurrency(holding.valueInEUR) }}</strong>
                  </td>
                </ng-container>

                <!-- Change 24h Column -->
                <ng-container matColumnDef="change24h">
                  <th mat-header-cell *matHeaderCellDef>24h Change</th>
                  <td mat-cell *matCellDef="let holding">
                    <span [class]="holding.change24hPercent >= 0 ? 'positive' : 'negative'">
                      {{ formatPercent(holding.change24hPercent) }}
                    </span>
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Actions</th>
                  <td mat-cell *matCellDef="let holding">
                    <button mat-icon-button (click)="sellForm.symbol = holding.cryptoSymbol; selectedTab = 2" aria-label="Sell">
                      <mat-icon>trending_down</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="holdingsColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: holdingsColumns"></tr>
              </table>
            </div>
          }
        </div>
      </mat-tab>

      <!-- Trading Tab -->
      <mat-tab label="Trade">
        <div class="tab-content">
          <div class="trading-section">
            <div class="trading-cards">
              <!-- Buy Card -->
              <mat-card class="trading-card buy-card">
                <mat-card-header>
                  <mat-card-title>
                    <mat-icon>trending_up</mat-icon>
                    Buy Crypto
                  </mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <form (ngSubmit)="onBuyCrypto()" class="trading-form">
                    <mat-form-field appearance="outline">
                      <mat-label>Select Cryptocurrency</mat-label>
                      <mat-select [(ngModel)]="buyForm.symbol" name="buySymbol" required>
                        @for (coin of availableCoins; track coin.id) {
                          <mat-option [value]="coin.symbol.toUpperCase()">
                            {{ coin.name }} ({{ coin.symbol.toUpperCase() }})
                          </mat-option>
                        }
                      </mat-select>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Amount in EUR</mat-label>
                      <input matInput type="number" [(ngModel)]="buyForm.eurAmount" name="buyAmount" required min="1" step="0.01">
                      <mat-icon matPrefix>euro</mat-icon>
                    </mat-form-field>

                    @if (buyForm.symbol && buyForm.eurAmount > 0) {
                      @if (getHolding(buyForm.symbol)) {
                        <div class="holding-info">
                          <p>Current holding: {{ formatCrypto(getHolding(buyForm.symbol)!.amount) }} {{ buyForm.symbol }}</p>
                        </div>
                      }
                      @if (getCoin(buyForm.symbol)) {
                        <div class="preview-info">
                          <p>You will receive approximately:</p>
                          <p class="preview-amount">
                            {{ formatCrypto(buyForm.eurAmount / getBuyCoinPrice(buyForm.symbol)) }} {{ buyForm.symbol }}
                          </p>
                          <p class="preview-price">&#64; {{ formatCurrency(getBuyCoinPrice(buyForm.symbol)) }} per {{ buyForm.symbol }}</p>
                        </div>
                      }
                    }

                    <app-custom-button
                      label="Buy"
                      icon="trending_up"
                      variant="primary"
                      type="submit"
                      [disabled]="!buyForm.symbol || buyForm.eurAmount <= 0 || portfolio!.wallet.balance < buyForm.eurAmount">
                    </app-custom-button>
                  </form>
                </mat-card-content>
              </mat-card>

              <!-- Sell Card -->
              <mat-card class="trading-card sell-card">
                <mat-card-header>
                  <mat-card-title>
                    <mat-icon>trending_down</mat-icon>
                    Sell Crypto
                  </mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <form (ngSubmit)="onSellCrypto()" class="trading-form">
                    <mat-form-field appearance="outline">
                      <mat-label>Select Cryptocurrency</mat-label>
                      <mat-select [(ngModel)]="sellForm.symbol" name="sellSymbol" required>
                        @for (holding of portfolio.holdings; track holding.cryptoSymbol) {
                          <mat-option [value]="holding.cryptoSymbol">
                            {{ holding.coinName || holding.cryptoSymbol }} ({{ holding.cryptoSymbol }})
                            - {{ formatCrypto(holding.amount) }} available
                          </mat-option>
                        }
                      </mat-select>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Amount to Sell</mat-label>
                      <input matInput type="number" [(ngModel)]="sellForm.cryptoAmount" name="sellAmount" required min="0.00000001" step="0.00000001">
                      <span matSuffix>{{ sellForm.symbol || 'CRYPTO' }}</span>
                    </mat-form-field>

                    @if (sellForm.symbol && sellForm.cryptoAmount > 0) {
                      @if (getSellHolding(sellForm.symbol)) {
                        <div class="preview-info">
                          <p>You will receive approximately:</p>
                          <p class="preview-amount">
                            {{ formatCurrency(sellForm.cryptoAmount * getSellHolding(sellForm.symbol)!.currentPrice) }}
                          </p>
                          <p class="preview-price">&#64; {{ formatCurrency(getSellHolding(sellForm.symbol)!.currentPrice) }} per {{ sellForm.symbol }}</p>
                        </div>
                      }
                    }

                    <app-custom-button
                      label="Sell"
                      icon="trending_down"
                      variant="danger"
                      type="submit"
                      [disabled]="!sellForm.symbol || sellForm.cryptoAmount <= 0 || !getHolding(sellForm.symbol) || getHolding(sellForm.symbol)!.amount < sellForm.cryptoAmount">
                    </app-custom-button>
                  </form>
                </mat-card-content>
              </mat-card>
            </div>
          </div>
        </div>
      </mat-tab>

      <!-- Analytics Tab -->
      <mat-tab label="Analytics">
        <div class="tab-content">
          <div class="analytics-section">
            <div class="charts-grid">
              @if (portfolioChartData) {
                <mat-card class="chart-card">
                  <mat-card-header>
                    <mat-card-title>Portfolio Distribution</mat-card-title>
                  </mat-card-header>
                  <mat-card-content>
                    <app-chart-widget
                      title="Holdings by Value"
                      type="bar"
                      [height]="300"
                      [data]="portfolioChartData">
                    </app-chart-widget>
                  </mat-card-content>
                </mat-card>
              }

              @if (performanceChartData) {
                <mat-card class="chart-card">
                  <mat-card-header>
                    <mat-card-title>Portfolio Performance</mat-card-title>
                  </mat-card-header>
                  <mat-card-content>
                    <app-chart-widget
                      title="7-Day Performance"
                      type="line"
                      [height]="300"
                      [data]="performanceChartData">
                    </app-chart-widget>
                  </mat-card-content>
                </mat-card>
              }
            </div>
          </div>
        </div>
      </mat-tab>

      <!-- Transactions Tab -->
      <mat-tab label="Transaction History">
        <div class="tab-content">
          @if (portfolio.transactions.length === 0) {
            <div class="empty-state">
              <mat-icon>history</mat-icon>
              <h3>No transactions yet</h3>
              <p>Your transaction history will appear here</p>
            </div>
          } @else {
            <div class="transactions-section">
              <table mat-table [dataSource]="portfolio.transactions" class="transactions-table">
                <!-- Date Column -->
                <ng-container matColumnDef="date">
                  <th mat-header-cell *matHeaderCellDef>Date</th>
                  <td mat-cell *matCellDef="let transaction">
                    {{ transaction.createdAt | date:'short' }}
                  </td>
                </ng-container>

                <!-- Type Column -->
                <ng-container matColumnDef="type">
                  <th mat-header-cell *matHeaderCellDef>Type</th>
                  <td mat-cell *matCellDef="let transaction">
                    <mat-chip [style.background-color]="getTransactionTypeColor(transaction.type)">
                      <mat-icon>{{ getTransactionTypeIcon(transaction.type) }}</mat-icon>
                      {{ transaction.type }}
                    </mat-chip>
                  </td>
                </ng-container>

                <!-- Symbol Column -->
                <ng-container matColumnDef="symbol">
                  <th mat-header-cell *matHeaderCellDef>Cryptocurrency</th>
                  <td mat-cell *matCellDef="let transaction">
                    <strong>{{ transaction.cryptoSymbol }}</strong>
                  </td>
                </ng-container>

                <!-- Amount Column -->
                <ng-container matColumnDef="amount">
                  <th mat-header-cell *matHeaderCellDef>Amount</th>
                  <td mat-cell *matCellDef="let transaction">
                    {{ formatCrypto(transaction.cryptoAmount) }} {{ transaction.cryptoSymbol }}
                  </td>
                </ng-container>

                <!-- Price Column -->
                <ng-container matColumnDef="price">
                  <th mat-header-cell *matHeaderCellDef>Price per Unit</th>
                  <td mat-cell *matCellDef="let transaction">
                    {{ formatCurrency(transaction.eurPricePerUnit) }}
                  </td>
                </ng-container>

                <!-- Total Column -->
                <ng-container matColumnDef="total">
                  <th mat-header-cell *matHeaderCellDef>Total (EUR)</th>
                  <td mat-cell *matCellDef="let transaction">
                    <strong>{{ formatCurrency(transaction.eurAmount) }}</strong>
                  </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>Status</th>
                  <td mat-cell *matCellDef="let transaction">
                    <mat-chip [style.background-color]="getStatusColor(transaction.status)">
                      {{ transaction.status }}
                    </mat-chip>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="transactionsColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: transactionsColumns"></tr>
              </table>
            </div>
          }
        </div>
      </mat-tab>
    </mat-tab-group>
  }
</div>

